import { applyMiddleware, compose, createStore, } from 'redux';
import { NgZone } from '@angular/core';
import { BehaviorSubject, Observable } from 'rxjs';
import { distinctUntilChanged, filter, map, switchMap } from 'rxjs/operators';
import { assert } from '../utils/assert';
import { enableFractalReducers } from './fractal-reducer-map';
import { NgRedux } from './ng-redux';
import { resolveToFunctionSelector, } from './selectors';
import { SubStore } from './sub-store';
/** @hidden */
export class RootStore extends NgRedux {
    constructor(ngZone) {
        super();
        this.ngZone = ngZone;
        this.store = undefined;
        this.configureStore = (rootReducer, initState, middleware = [], enhancers = []) => {
            assert(!this.store, 'Store already configured!');
            // Variable-arity compose in typescript FTW.
            this.setStore(compose(applyMiddleware(...middleware), ...enhancers)(createStore)(enableFractalReducers(rootReducer), initState));
        };
        this.provideStore = (store) => {
            assert(!this.store, 'Store already configured!');
            this.setStore(store);
        };
        this.getState = () => this.store.getState();
        this.subscribe = (listener) => this.store.subscribe(listener);
        this.replaceReducer = (nextReducer) => {
            this.store.replaceReducer(nextReducer);
        };
        this.dispatch = (action) => {
            assert(!!this.store, 'Dispatch failed: did you forget to configure your store? ' +
                'https://github.com/angular-redux/platform/blob/master/packages/store/' +
                'README.md#quick-start');
            if (!NgZone.isInAngularZone()) {
                return this.ngZone.run(() => this.store.dispatch(action));
            }
            else {
                return this.store.dispatch(action);
            }
        };
        this.select = (selector, comparator) => this.store$.pipe(distinctUntilChanged(), map(resolveToFunctionSelector(selector)), distinctUntilChanged(comparator));
        this.configureSubStore = (basePath, localReducer) => new SubStore(this, basePath, localReducer);
        this.storeToObservable = (store) => new Observable((observer) => {
            observer.next(store.getState());
            const unsubscribeFromRedux = store.subscribe(() => observer.next(store.getState()));
            return () => {
                unsubscribeFromRedux();
                observer.complete();
            };
        });
        NgRedux.instance = this;
        this.store$ = new BehaviorSubject(undefined).pipe(filter(n => n !== undefined), switchMap(observableStore => observableStore));
    }
    setStore(store) {
        this.store = store;
        const storeServable = this.storeToObservable(store);
        this.store$.next(storeServable);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm9vdC1zdG9yZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0Bhbmd1bGFyLXJlZHV4L3N0b3JlLyIsInNvdXJjZXMiOlsiY29tcG9uZW50cy9yb290LXN0b3JlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFFTCxlQUFlLEVBQ2YsT0FBTyxFQUNQLFdBQVcsR0FRWixNQUFNLE9BQU8sQ0FBQztBQUVmLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDdkMsT0FBTyxFQUFFLGVBQWUsRUFBRSxVQUFVLEVBQVksTUFBTSxNQUFNLENBQUM7QUFDN0QsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDOUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3pDLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQzlELE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFFckMsT0FBTyxFQUdMLHlCQUF5QixHQUUxQixNQUFNLGFBQWEsQ0FBQztBQUNyQixPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBRXZDLGNBQWM7QUFDZCxNQUFNLE9BQU8sU0FBcUIsU0FBUSxPQUFrQjtJQUkxRCxZQUFvQixNQUFjO1FBQ2hDLEtBQUssRUFBRSxDQUFDO1FBRFUsV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQUgxQixVQUFLLEdBQWlDLFNBQVMsQ0FBQztRQWN4RCxtQkFBYyxHQUFHLENBQ2YsV0FBMEMsRUFDMUMsU0FBb0IsRUFDcEIsYUFBMkIsRUFBRSxFQUM3QixZQUF3QyxFQUFFLEVBQ3BDLEVBQUU7WUFDUixNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLDJCQUEyQixDQUFDLENBQUM7WUFDakQsNENBQTRDO1lBQzVDLElBQUksQ0FBQyxRQUFRLENBQ1gsT0FBTyxD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QjtRQUN0QyxJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztRQUNuQixNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDcEQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsYUFBb0IsQ0FBQyxDQUFDO0lBQ3pDLENBQUM7Q0FlRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEFueUFjdGlvbixcbiAgYXBwbHlNaWRkbGV3YXJlLFxuICBjb21wb3NlLFxuICBjcmVhdGVTdG9yZSxcbiAgRGlzcGF0Y2gsXG4gIE1pZGRsZXdhcmUsXG4gIFJlZHVjZXIsXG4gIFN0b3JlLFxuICBTdG9yZUNyZWF0b3IsXG4gIFN0b3JlRW5oYW5jZXIsXG4gIFVuc3Vic2NyaWJlLFxufSBmcm9tICdyZWR1eCc7XG5cbmltcG9ydCB7IE5nWm9uZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0LCBPYnNlcnZhYmxlLCBPYnNlcnZlciB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZGlzdGluY3RVbnRpbENoYW5nZWQsIGZpbHRlciwgbWFwLCBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBhc3NlcnQgfSBmcm9tICcuLi91dGlscy9hc3NlcnQnO1xuaW1wb3J0IHsgZW5hYmxlRnJhY3RhbFJlZHVjZXJzIH0gZnJvbSAnLi9mcmFjdGFsLXJlZHVjZXItbWFwJztcbmltcG9ydCB7IE5nUmVkdXggfSBmcm9tICcuL25nLXJlZHV4JztcbmltcG9ydCB7IE9ic2VydmFibGVTdG9yZSB9IGZyb20gJy4vb2JzZXJ2YWJsZS1zdG9yZSc7XG5pbXBvcnQge1xuICBDb21wYXJhdG9yLFxuICBQYXRoU2VsZWN0b3IsXG4gIHJlc29sdmVUb0Z1bmN0aW9uU2VsZWN0b3IsXG4gIFNlbGVjdG9yLFxufSBmcm9tICcuL3NlbGVjdG9ycyc7XG5pbXBvcnQgeyBTdWJTdG9yZSB9IGZyb20gJy4vc3ViLXN0b3JlJztcblxuLyoqIEBoaWRkZW4gKi9cbmV4cG9ydCBjbGFzcyBSb290U3RvcmU8Um9vdFN0YXRlPiBleHRlbmRzIE5nUmVkdXg8Um9vdFN0YXRlPiB7XG4gIHByaXZhdGUgc3RvcmU6IFN0b3JlPFJvb3RTdGF0ZT4gfCB1bmRlZmluZWQgPSB1bmRlZmluZWQ7XG4gIHByaXZhdGUgc3RvcmUkOiBCZWhhdmlvclN1YmplY3Q8Um9vdFN0YXRlPjtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIG5nWm9uZTogTmdab25lKSB7XG4gICAgc3VwZXIoKTtcblxuICAgIE5nUmVkdXguaW5zdGFuY2UgPSB0aGlzO1xuICAgIHRoaXMuc3RvcmUkID0gbmV3IEJlaGF2aW9yU3ViamVjdDxSb290U3RhdGUgfCB1bmRlZmluZWQ+KHVuZGVmaW5lZCkucGlwZShcbiAgICAgIGZpbHRlcihuID0+IG4gIT09IHVuZGVmaW5lZCksXG4gICAgICBzd2l0Y2hNYXAob2JzZXJ2YWJsZVN0b3JlID0+IG9ic2VydmFibGVTdG9yZSBhcyBhbnkpLFxuICAgICAgLy8gVE9ETzogZml4IHRoaXM/IG5lZWRpbmcgdG8gZXhwbGljaXRseSBjYXN0IHRoaXMgaXMgd3JvbmdcbiAgICApIGFzIEJlaGF2aW9yU3ViamVjdDxSb290U3RhdGU+O1xuICB9XG5cbiAgY29uZmlndXJlU3RvcmUgPSAoXG4gICAgcm9vdFJlZHVjZXI6IFJlZHVjZXI8Um9vdFN0YXRlLCBBbnlBY3Rpb24+LFxuICAgIGluaXRTdGF0ZTogUm9vdFN0YXRlLFxuICAgIG1pZGRsZXdhcmU6IE1pZGRsZXdhcmVbXSA9IFtdLFxuICAgIGVuaGFuY2VyczogU3RvcmVFbmhhbmNlcjxSb290U3RhdGU+W10gPSBbXSxcbiAgKTogdm9pZCA9PiB7XG4gICAgYXNzZXJ0KCF0aGlzLnN0b3JlLCAnU3RvcmUgYWxyZWFkeSBjb25maWd1cmVkIScpO1xuICAgIC8vIFZhcmlhYmxlLWFyaXR5IGNvbXBvc2UgaW4gdHlwZXNjcmlwdCBGVFcuXG4gICAgdGhpcy5zZXRTdG9yZShcbiAgICAgIGNvbXBvc2U8U3RvcmVDcmVhdG9yPihcbiAgICAgICAgYXBwbHlNaWRkbGV3YXJlKC4uLm1pZGRsZXdhcmUpLFxuICAgICAgICAuLi5lbmhhbmNlcnMsXG4gICAgICApKGNyZWF0ZVN0b3JlKShlbmFibGVGcmFjdGFsUmVkdWNlcnMocm9vdFJlZHVjZXIpLCBpbml0U3RhdGUpLFxuICAgICk7XG4gIH07XG5cbiAgcHJvdmlkZVN0b3JlID0gKHN0b3JlOiBTdG9yZTxSb290U3RhdGU+KSA9PiB7XG4gICAgYXNzZXJ0KCF0aGlzLnN0b3JlLCAnU3RvcmUgYWxyZWFkeSBjb25maWd1cmVkIScpO1xuICAgIHRoaXMuc2V0U3RvcmUoc3RvcmUpO1xuICB9O1xuXG4gIGdldFN0YXRlID0gKCk6IFJvb3RTdGF0ZSA9PiB0aGlzLnN0b3JlIS5nZXRTdGF0ZSgpO1xuXG4gIHN1YnNjcmliZSA9IChsaXN0ZW5lcjogKCkgPT4gdm9pZCk6IFVuc3Vic2NyaWJlID0+XG4gICAgdGhpcy5zdG9yZSEuc3Vic2NyaWJlKGxpc3RlbmVyKTtcblxuICByZXBsYWNlUmVkdWNlciA9IChuZXh0UmVkdWNlcjogUmVkdWNlcjxSb290U3RhdGUsIEFueUFjdGlvbj4pOiB2b2lkID0+IHtcbiAgICB0aGlzLnN0b3JlIS5yZXBsYWNlUmVkdWNlcihuZXh0UmVkdWNlcik7XG4gIH07XG5cbiAgZGlzcGF0Y2g6IERpc3BhdGNoPEFueUFjdGlvbj4gPSA8QSBleHRlbmRzIEFueUFjdGlvbj4oYWN0aW9uOiBBKTogQSA9PiB7XG4gICAgYXNzZXJ0KFxuICAgICAgISF0aGlzLnN0b3JlLFxuICAgICAgJ0Rpc3BhdGNoIGZhaWxlZDogZGlkIHlvdSBmb3JnZXQgdG8gY29uZmlndXJlIHlvdXIgc3RvcmU/ICcgK1xuICAgICAgICAnaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXItcmVkdXgvcGxhdGZvcm0vYmxvYi9tYXN0ZXIvcGFja2FnZXMvc3RvcmUvJyArXG4gICAgICAgICdSRUFETUUubWQjcXVpY2stc3RhcnQnLFxuICAgICk7XG5cbiAgICBpZiAoIU5nWm9uZS5pc0luQW5ndWxhclpvbmUoKSkge1xuICAgICAgcmV0dXJuIHRoaXMubmdab25lLnJ1bigoKSA9PiB0aGlzLnN0b3JlIS5kaXNwYXRjaChhY3Rpb24pKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHRoaXMuc3RvcmUhLmRpc3BhdGNoKGFjdGlvbik7XG4gICAgfVxuICB9O1xuXG4gIHNlbGVjdCA9IDxTZWxlY3RlZFR5cGU+KFxuICAgIHNlbGVjdG9yPzogU2VsZWN0b3I8Um9vdFN0YXRlLCBTZWxlY3RlZFR5cGU+LFxuICAgIGNvbXBhcmF0b3I/OiBDb21wYXJhdG9yLFxuICApOiBPYnNlcnZhYmxlPFNlbGVjdGVkVHlwZT4gPT5cbiAgICB0aGlzLnN0b3JlJC5waXBlKFxuICAgICAgZGlzdGluY3RVbnRpbENoYW5nZWQoKSxcbiAgICAgIG1hcChyZXNvbHZlVG9GdW5jdGlvblNlbGVjdG9yKHNlbGVjdG9yKSksXG4gICAgICBkaXN0aW5jdFVudGlsQ2hhbmdlZChjb21wYXJhdG9yKSxcbiAgICApO1xuXG4gIGNvbmZpZ3VyZVN1YlN0b3JlID0gPFN1YlN0YXRlPihcbiAgICBiYXNlUGF0aDogUGF0aFNlbGVjdG9yLFxuICAgIGxvY2FsUmVkdWNlcjogUmVkdWNlcjxTdWJTdGF0ZSwgQW55QWN0aW9uPixcbiAgKTogT2JzZXJ2YWJsZVN0b3JlPFN1YlN0YXRlPiA9PlxuICAgIG5ldyBTdWJTdG9yZTxTdWJTdGF0ZT4odGhpcywgYmFzZVBhdGgsIGxvY2FsUmVkdWNlcik7XG5cbiAgcHJpdmF0ZSBzZXRTdG9yZShzdG9yZTogU3RvcmU8Um9vdFN0YXRlPikge1xuICAgIHRoaXMuc3RvcmUgPSBzdG9yZTtcbiAgICBjb25zdCBzdG9yZVNlcnZhYmxlID0gdGhpcy5zdG9yZVRvT2JzZXJ2YWJsZShzdG9yZSk7XG4gICAgdGhpcy5zdG9yZSQubmV4dChzdG9yZVNlcnZhYmxlIGFzIGFueSk7XG4gIH1cblxuICBwcml2YXRlIHN0b3JlVG9PYnNlcnZhYmxlID0gKFxuICAgIHN0b3JlOiBTdG9yZTxSb290U3RhdGU+LFxuICApOiBPYnNlcnZhYmxlPFJvb3RTdGF0ZT4gPT5cbiAgICBuZXcgT2JzZXJ2YWJsZTxSb290U3RhdGU+KChvYnNlcnZlcjogT2JzZXJ2ZXI8Um9vdFN0YXRlPikgPT4ge1xuICAgICAgb2JzZXJ2ZXIubmV4dChzdG9yZS5nZXRTdGF0ZSgpKTtcbiAgICAgIGNvbnN0IHVuc3Vic2NyaWJlRnJvbVJlZHV4ID0gc3RvcmUuc3Vic2NyaWJlKCgpID0+XG4gICAgICAgIG9ic2VydmVyLm5leHQoc3RvcmUuZ2V0U3RhdGUoKSksXG4gICAgICApO1xuICAgICAgcmV0dXJuICgpID0+IHtcbiAgICAgICAgdW5zdWJzY3JpYmVGcm9tUmVkdXgoKTtcbiAgICAgICAgb2JzZXJ2ZXIuY29tcGxldGUoKTtcbiAgICAgIH07XG4gICAgfSk7XG59XG4iXX0=